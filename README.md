<div align="center">
  <p>
    <img src="docs/logo.png" alt="ImpulsoGOV" width="550px" />
    <h2>Projeto de Arquitetura e ETL</h2>
  </p>
</div>

## Sum√°rio

- [1 - Introdu√ß√£o](#)
- [2 - Mapeamento de componentes do sistema](#)
  - [2.1 - Modelagem do Dom√≠nio (DDD - Domain Driven Design)](#)
  - [2.2 - Digrama de Sequ√™ncia](#)
- [3 - An√°lise Cr√≠tica e Identifica√ß√£o de Riscos](#)
  - [3.1 - Insights de "Quick Wins"](#)
  - [3.2 - ImpulsoGOV Tech Radar](#)
- [4 - Propostas de melhoria](#)
  - [4.1 - Novo M√©todo de Extra√ß√£o e Transmiss√£o - API Restful](#)
  - [4.2 - Implementa√ß√£o de Processo de ETL Apache Airflow](#)
  - [4.3 - Melhorias no Processo de Comunica√ß√£o - API intermedi√°ria](#)
  - - [4.3.1 - Proposta de implementa√ß√£o](#)

---

## 1 - Introdu√ß√£o

A [ImpulsoGOV](https://www.impulsogov.org/) √© uma organiza√ß√£o de tecnologia do terceiro setor que faz uso inteligente de dados para transformar a sa√∫de p√∫blica do Brasil.

[üéØ Desafio original](https://impulsogov.notion.site/Case-CTO-885231d00e494dc5bd2332f1053d3cbd)

## 2 - Mapeamento de componentes do sistema:

<details>
  <summary>
    üîß &nbsp; Back-end & ETL - Arquitetura Atual</a>
  </summary>

- **Linguagem:** `Python`
- **Framework:** `FastAPI`

### Processo de ETL:

- O `transmissor` atual √© um `conector do Postgres` aplicado ao banco de dados do munic√≠pio.
- `Conex√£o direta` entre o `transmissor` e o `banco de dados anal√≠tico` da ImpulsoGov.
- Uma `procedure` no `banco do munic√≠pio` executa `consultas` em tabelas locais e `insere` os resultados no banco de dados anal√≠tico.

### Banco do Munic√≠pio:

- Propriedade e gest√£o pertencentes ao pr√≥prio munic√≠pio.
- - Localizado em servidores locais ou em nuvem.
- - Varia√ß√µes na presen√ßa de pessoal de TI.
- Todos os munic√≠pios possuem um banco `padr√£o acoplado` ao `PEC (Software do SUS)`, resultando em uma modelagem consistente.

### Rotina de Transmiss√£o:

- `Diariamente`, no in√≠cio da manh√£, iniciam-se os processos de transmiss√£o.
- - Geralmente, no in√≠cio da tarde, todos os dados do dia s√£o recebidos.
- A instala√ß√£o do transmissor √© de responsabilidade da ImpulsoGov.

</details>

---

#### üèóÔ∏è &nbsp; 2.1 - Modelagem do Dom√≠nio (DDD - Domain Driven Design)

<details>
  <summary>
    Entidades Principais
  </summary>
&nbsp;

| Entidades Principais | Defini√ß√µes                                                                                                                                                   |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| ImpulsoGov           | Respons√°vel pela l√≥gica de aplica√ß√£o, incluindo o Backend (Python com FastAPI), Processo de ETL, Rotina de Transmiss√£o e Instala√ß√£o do Transmissor.          |
|                      | `Agregados`: Backend (Python, FastAPI), Processo de ETL (Transmissor, Banco do Munic√≠pio, Rotina de Transmiss√£o), Banco do Munic√≠pio, Rotina de Transmiss√£o. |
|                      | `Objetos de Valor`: Conex√£o Direta, Procedure no Banco do Munic√≠pio, Modelagem Consistente.                                                                  |

</details>

<details>
  <summary>
    Contextos Delimitados
  </summary>
&nbsp;

| Contextos Delimitados | Defini√ß√µes                                                                                                                                                                   |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ImpulsoGov            | Desenvolvimento do `Backend` em `Python` com `FastAPI`, Processo de `ETL` (Extra√ß√£o, Transforma√ß√£o e Carregamento), Rotina de `Transmiss√£o` e `Instala√ß√£o` do `Transmissor`. |
| Banco do Munic√≠pio    | Gerencia propriedade, localiza√ß√£o e varia√ß√µes de pessoal de TI nos bancos municipais.                                                                                        |
| Rotina de Transmiss√£o | Define os processos `di√°rios` de `transmiss√£o` de dados.                                                                                                                     |

</details>

<details>
  <summary>
    Gloss√°rio
  </summary>
&nbsp;

|     | **Termo T√©cnico**                   | **Explica√ß√£o T√©cnica**                                                                              | **Contexto ImpulsoGov**                                                                              |
| --- | ----------------------------------- | --------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------- |
| üîç  | **Entidades**                       | Objetos identific√°veis e fundamentais para o dom√≠nio, mantendo uma exist√™ncia ao longo do tempo.    | A `Entidade Backend` √© central no sistema.                                                           |
| üîÑ  | **Agregados**                       | Agrupamentos de entidades e objetos de valor para garantir consist√™ncia no dom√≠nio.                 | O `Processo de ETL` √© um agregado com `Transmissor`, `Banco do Munic√≠pio` e `Rotina de Transmiss√£o`. |
| üì¶  | **Objetos de Valor**                | Objetos sem identidade pr√≥pria, definidos por atributos, trazendo valor pela composi√ß√£o.            | Exemplo de objeto de valor √© a `Conex√£o Direta`.                                                     |
| üåê  | **Contextos Delimitados**           | √Åreas do dom√≠nio com regras espec√≠ficas, onde termos t√™m significados isolados.                     | Dentro do `Banco do Munic√≠pio`, estabelecemos nossas pr√≥prias regras.                                |
| üíª  | **Backend**                         | L√≥gica de aplica√ß√£o, processamento de dados e intera√ß√£o com o usu√°rio.                              | Nosso `Backend` √© desenvolvido em `Python` com `FastAPI`.                                            |
| üîÑ  | **Processo de ETL**                 | Atividades de Extra√ß√£o, Transforma√ß√£o e Carregamento de dados entre sistemas ou bancos de dados.    | O `Transmissor` √© crucial no `Processo de ETL`.                                                      |
| üì°  | **Transmissor (Postgres)**          | Componente que extrai dados de um banco PostgreSQL e os transmite para outro local.                 | O `Transmissor` conecta o `Banco do Munic√≠pio` ao `Banco Anal√≠tico`.                                 |
| üîÑ  | **Procedure no Banco do Munic√≠pio** | Rotina armazenada no banco de dados que executa consultas e insere resultados.                      | As `Procedures` no `Banco do Munic√≠pio` manipulam dados no `Banco Anal√≠tico`.                        |
| üèóÔ∏è  | **Modelagem Consistente**           | Abordagem para manter um padr√£o uniforme na estrutura e design dos dados.                           | Garantimos uma `Modelagem Consistente` em todos os `Bancos do Munic√≠pio`.                            |
| üîó  | **Conex√£o Direta**                  | Estabelecimento de uma liga√ß√£o direta entre dois componentes para transfer√™ncia eficiente de dados. | A `Conex√£o Direta` entre o `Transmissor` e os `Bancos` garante transfer√™ncia eficiente.              |

</details>

---

#### üîÑ &nbsp; 2.2 - Digrama de Sequ√™ncia

```mermaid

sequenceDiagram
  participant Transmissor
  participant BancoMunicipio
  participant BancoAnalitico

  Transmissor ->> BancoMunicipio: Conectar ao BancoMunicipio
  activate BancoMunicipio

  Transmissor ->> BancoMunicipio: Executar consulta em tabelas locais
  note over BancoMunicipio: Procedure no BancoMunicipio

  BancoMunicipio -->> Transmissor: Resultados da consulta

  Transmissor ->> BancoAnalitico: Conectar ao BancoAnalitico da ImpulsoGov
  activate BancoAnalitico

  Transmissor ->> BancoAnalitico: Inserir resultados no BancoAnalitico
  note over BancoAnalitico: Transforma√ß√£o e carga de dados

  BancoAnalitico -->> Transmissor: Confirma√ß√£o de carga

  deactivate BancoMunicipio
  deactivate BancoAnalitico

```

---

## üßê &nbsp; 3 - An√°lise Cr√≠tica e Identifica√ß√£o de Riscos

> üì¢ Nota: Eu fiz a avalia√ß√£o exclusivamente com base nas informa√ß√µes e tecnologias fornecidas durante os processos de entrevistas com [Pedro Drummond](https://www.linkedin.com/in/pedro-drummond/), [Gabrielle Arruda](https://www.linkedin.com/in/gabrielle-arruda/) e o escopo do case proposto pelo **Levi**.
>
> <img src="docs/bruce-buffer.png" align="left" alt="VAR" width="120" border="5px solid transparent" />
>
> ```
> ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó
> ‚ñà‚ñà‚ïë‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù    ‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë
> ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó       ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë
> ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ñà‚ñà‚ïë       ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ïö‚ïê‚ïù
> ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë       ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó
> ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù       ‚ïö‚ïê‚ïù   ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù
> ```

A partir do diagrama de sequ√™ncia identifiquei alguns pontos **"protocolares"** s√£o importantes ser validados antes de iniciativas de escala: Inspecionar a sa√∫de do sistema e de seus componentes de forma an√°loga [avia√ß√£o (checklist e preflight)](https://hangarmma.com.br/blog/o-que-sao-checklists-de-voo/):

| **Aspecto**                 | **Vantagens**                           | **Pontos de Aten√ß√£o**                                 | **Valida√ß√µes**                                                                                                                                                                                          | **Mitiga√ß√£o de Risco**                                                                                                                                                                           | **Sugest√µes**                                                                                                                                                                                              |
| --------------------------- | --------------------------------------- | ----------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| üõ°Ô∏è **Seguran√ßa da Conex√£o** | üöÄ Conex√£o r√°pida                       | üîê Seguran√ßa                                          | ‚úÖ Validar tempos de resposta para garantir efici√™ncia. <br/><br/> ‚úÖ Auditar configura√ß√µes de seguran√ßa, incluindo autentica√ß√£o e criptografia. <br/><br/> ‚úÖ Implementar monitoramento em tempo real. | üìã Refor√ßar seguran√ßa por meio de patches cont√≠nuos. <br/><br/> üìã Sanitiza√ß√£o dos dados de entrada das rotas para prevenir ataques comuns, como inje√ß√£o de SQL e XSS (Cross-Site Scripting)     | üëâ Implementar autentica√ß√£o e criptografia _OAuth2_ e _JWT_. <br/><br/> üëâ Configurar alertas autom√°ticos para monitoramento cont√≠nuo com RapidAPI.                                                        |
|                             | üìä Padroniza√ß√£o: Facilita manuten√ß√£o.   | üõë Varia√ß√£o de Pessoal de TI: Pode afetar seguran√ßa.  | ‚úÖ Revisar documenta√ß√£o para garantir conformidade. <br/><br/> ‚úÖ Implementar treinamentos remotos para padroniza√ß√£o. <br/><br/> ‚úÖ Monitorar atividades e fornecer suporte t√©cnico remoto.             | üìã Estabelecer diretrizes claras para seguran√ßa consistente. <br/><br/> üìã Oferecer treinamento remoto adicional, se necess√°rio.                                                                 | üëâ Criar documenta√ß√£o t√©cnica com exemplos de seguran√ßa usando FastAPI e [Swagger](https://github.com/swagger-api/swagger-ui) <br/><br/> üëâ Oferecer webinars ou tutoriais online para treinamento remoto. |
| üöÄ **Desempenho**           | üîÑ Atualiza√ß√£o Di√°ria: Processo eficaz. | ‚ö†Ô∏è Poss√≠veis Gargalos: Risco de efici√™ncia.           | ‚úÖ Realizar testes de carga para identificar gargalos. <br/><br/> ‚úÖ Monitorar tempos de processamento di√°rio. <br/><br/> ‚úÖ Implementar t√©cnicas de otimiza√ß√£o.                                        | üìã Avaliar e implementar solu√ß√µes escal√°veis. <br/><br/> üìã Explorar ferramentas avan√ßadas de monitoramento para identificar gargalos.                                                           | üëâ Utilizar √≠ndices eficientes no PostgreSQL para otimizar recupera√ß√£o de dados. <br/><br/> üëâ Explorar ferramentas de otimiza√ß√£o de consulta para melhor desempenho do PostgreSQL.                        |
|                             | üöÄ Efici√™ncia com Grandes Dados.        | üåê Impacto na Infraestrutura: Pode afetar desempenho. | ‚úÖ Realizar testes de desempenho com grandes volumes de dados. <br/><br/> ‚úÖ Monitorar tempos de resposta em diferentes ambientes. <br/><br/> ‚úÖ Estabelecer diretrizes claras.                         | üìã Investir em an√°lise de infraestrutura em munic√≠pios com varia√ß√µes significativas. <br/><br/> üìã Considerar caches locais para melhor efici√™ncia no processamento de grandes volumes de dados. | üëâ Utilizar t√©cnicas de particionamento no PostgreSQL para otimizar consultas em grandes volumes de dados. <br/><br/> üëâ Explorar √≠ndices adequados para consultas frequentes.                             |

---

> üëå Sem _"chover no molhado"_, O `PostgreSQL` j√° re√∫ne uma lista exaustiva de [vantagens](https://www.postgresql.org/about/featurematrix/) em rela√ß√£o a outros bancos de dados opensource - sendo praticamente um padr√£o de mercado para solu√ß√µes ETL Data Warehouse.

<details>
  <summary>
    üåü Postgres - Destaques
  </summary>
&nbsp;

- [x] O PostgreSQL adota o `Multi-Version Concurrency Control (MVCC)`, que possibilita opera√ß√µes `concorrentes eficientes`, importante no processamento de grandes volumes de dados dos munic√≠pios que exijam escrita e leitura (nas transforma√ß√µes) da `inst√¢ncia anal√≠tica` sem `locks`, garantindo isolamento transacional e consist√™ncia nos resultados.
- [x] Suporte a tipos de dados avan√ßados dando mais felxibilidade em transforma√ß√µes complexas durante as etapas de ETL.
- [x] Desempenho robusto. √â capaz de lidar eficientemente com `grandes volumes` de dados.
- [x] O suporte completo a `transa√ß√µes ACID` (Atomicidade, Consist√™ncia, Isolamento e Durabilidade), incluindo o `MVCC`, assegura uma recupera√ß√£o consistente em situa√ß√µes de falhas.

</details>

---

#### üí° &nbsp; 3.1 - Insights de "Quick Wins":

- üëâ Boa parte das valida√ß√µes implicam no monitoramento e o **FastAPI** possui suporte nativo para [Prometheus](https://prometheus.io/) para coletar m√©tricas de desempenho, lat√™ncia e etc, que podem ser integradas diretamente outras solu√ß√µes de visualiza√ß√£o de m√©tricas como o [Grafana](https://grafana.com/) - [Tutorial de exemplo](https://dev.to/ken_mwaura1/getting-started-monitoring-a-fastapi-app-with-grafana-and-prometheus-a-step-by-step-guide-3fbn), e ambas tamb√©m podem ser integradas a ferramentas de instrumentaliza√ß√£o como o **OpenTelemetry** para a gest√£o de dados de telemetria garantindo `vis√£o sist√™mica hol√≠stica` de todos os `dom√≠nios de aplica√ß√µes` da **ImpulsoGOV** - [Tutorial de exemplo](https://grafana.com/blog/2022/05/10/how-to-collect-prometheus-metrics-with-the-opentelemetry-collector-and-grafana/.)

---

## üß≠ &nbsp; 3.2 - ImpulsoGOV Tech Radar

A partir do contexto e do mapeamento eu produzi uma vers√£o _muuito_ mais simplificada de um [tech radar](https://www.thoughtworks.com/en-br/radar) (_com o objetivo de manter o escopo do desafio_) mas que ajuda a construir uma representa√ß√£o visual clara do cen√°rio tecnol√≥gico, facilita a tomada de decis√µes estrat√©gicas e o alinhamento das escolhas tecnol√≥gicas com os objetivos de neg√≥cios - j√° adicionando algumas das sugest√µes de melhorias e integra√ß√µes.

[![](https://mermaid.ink/img/pako:eNqVlF2TmjAUhv9KJh2vijtqYFUuOuP4sd2dbmtXpp_sRQoHySwQGoKVOvz3hkQrdnTGcsHF-zw5CSE5OxzwELCLO50dy5h00c7HP0saCprJaUyF9HGTZUg9Pg6a5DMLZdzEI9Kz0Al6C2wdyz2rj1DGkMInKhj9kUDRKmnwYcL-giVJQ338isxvp_bAx4cip-agZfYXg6k9u2SSljlcEIc4l0y7bc6HczJW5tllerCVLTmKoovrvF4l16v2WfWcueQsu7KoVq8u_GWyZcU_tjOckplzYcDX_x3gMZnAGdm4NarrTsfPTs-qQrIZhu7TvEwKfsc3yIMgRk80pKLB2y5V60DzDZNUoG73DZqEXBpWGeZB8ZdtaMIMPEzU7aP5NqdZyE7jAVoKnvINnMYEPQE9U8VGj5DEXJj4vdqXh5WLvvdubi2kXs9NuqxkzDP0Gi1oISfLe82HTiMMHWOoKUFdrrI4jh0ZdCdoHn98p_OeBo4BXpVDEQiWS80GTot9yCHzIFGXVYpKY1vjMTnUjGhGW2A_2YwHLyB0bsrpdAVCbYe68MWREIMe1J60FmE3yB5oNMlpEAOaMBEl_Ffrmw1e8kKuBRSr_bcZdus8YwunIFLKQtXOdHvZ9x1zftT_f2kOT608Wkq-qrIAu1KUYOEyD6mEGaNrQVPsRjQpVKp-MnZ3eIvdnoUr7PZHN05t4d-cK0ftiXnsHhmrpuL0LQwhk1w8moaq-6ou8k0PaGaq_wAwQ58w?type=png)](https://mermaid.live/edit#pako:eNqVlF2TmjAUhv9KJh2vijtqYFUuOuP4sd2dbmtXpp_sRQoHySwQGoKVOvz3hkQrdnTGcsHF-zw5CSE5OxzwELCLO50dy5h00c7HP0saCprJaUyF9HGTZUg9Pg6a5DMLZdzEI9Kz0Al6C2wdyz2rj1DGkMInKhj9kUDRKmnwYcL-giVJQ338isxvp_bAx4cip-agZfYXg6k9u2SSljlcEIc4l0y7bc6HczJW5tllerCVLTmKoovrvF4l16v2WfWcueQsu7KoVq8u_GWyZcU_tjOckplzYcDX_x3gMZnAGdm4NarrTsfPTs-qQrIZhu7TvEwKfsc3yIMgRk80pKLB2y5V60DzDZNUoG73DZqEXBpWGeZB8ZdtaMIMPEzU7aP5NqdZyE7jAVoKnvINnMYEPQE9U8VGj5DEXJj4vdqXh5WLvvdubi2kXs9NuqxkzDP0Gi1oISfLe82HTiMMHWOoKUFdrrI4jh0ZdCdoHn98p_OeBo4BXpVDEQiWS80GTot9yCHzIFGXVYpKY1vjMTnUjGhGW2A_2YwHLyB0bsrpdAVCbYe68MWREIMe1J60FmE3yB5oNMlpEAOaMBEl_Ffrmw1e8kKuBRSr_bcZdus8YwunIFLKQtXOdHvZ9x1zftT_f2kOT608Wkq-qrIAu1KUYOEyD6mEGaNrQVPsRjQpVKp-MnZ3eIvdnoUr7PZHN05t4d-cK0ftiXnsHhmrpuL0LQwhk1w8moaq-6ou8k0PaGaq_wAwQ58w)

## üî© &nbsp; 4 - Proposta de Melhorias no Processo de ETL e Comunica√ß√£o de Dados:

> üì¢ Nota: Com base nas informa√ß√µes compartilhadas durante os processos de entrevistas com [Pedro Drummond](https://www.linkedin.com/in/pedro-drummond/) e [Gabrielle Arruda](https://www.linkedin.com/in/gabrielle-arruda/) entendi que a **ImpulsoGOV** utiliza as solu√ß√µes cloud **GCP**. Optei por propor **solu√ß√µes incrementais** - utilizando o servi√ßo adotado.

#### 4.1 - üì• Novo M√©todo de Extra√ß√£o e Transmiss√£o - API Restful:

- [ ] `Introdu√ß√£o de API Restful para Extra√ß√£o`:
  - **Motiva√ß√£o**: Minimizar os riscos de `seguran√ßa (da comunica√ß√£o direta entre os bancos)` e otimizar a efici√™ncia da extra√ß√£o de dados dos **bancos municipais** na infraestrutura da Google Cloud Platform (GCP).

**Benef√≠cios**:

- **Utiliza√ß√£o das tecnologias j√° adotadas pela ImpulsoGOV**: - **Python** + **FastAPI**, integrando com [Cloud Endpoints](https://cloud.google.com/endpoints?hl=pt-br) na GCP.
- **Seguran√ßa**: A API permitir√° autentica√ß√£o usando servi√ßos da GCP, como [Identity and Access Management (IAM)](https://cloud.google.com/security/products/iam?hl=pt-br), garantindo uma camada adicional de seguran√ßa:

```mermaid

sequenceDiagram
  participant Transmissor
  participant API_Restful
  participant BancoMunicipio
  participant GCP

  Transmissor ->> API_Restful: Solicitar dados via API
  activate API_Restful

  API_Restful ->> BancoMunicipio: Autenticar e Extrair Dados
  note over BancoMunicipio: Processo seguro usando IAM

  BancoMunicipio -->> API_Restful: Dados Extra√≠dos

  API_Restful -->> Transmissor: Resposta com Dados

  API_Restful ->> GCP: Transmitir dados para o banco anal√≠tico
  note over GCP: Utilizando Cloud Endpoints

  GCP -->> API_Restful: Confirma√ß√£o de Recebimento

  deactivate API_Restful

```

> O Transmissor solicita dados por meio da API Restful, que autentica e extrai dados de forma segura do Banco Municipal utilizando o IAM. Posteriormente, os dados s√£o transmitidos para o banco anal√≠tico na GCP atrav√©s do Cloud Endpoints, com confirma√ß√£o de recebimento pela GCP.

---

#### 4.2 - üîÑ Implementa√ß√£o de Processo de ETL Apache Airflow:

> üì¢ Nota: Como n√£o sou especialista em egenharia de dados e a ImpulsoGOV j√° possui um **time com mais experi√™ncia** no dom√≠nio e as necessidades da demanda atual, segui o caminho sugerido no desafio, utilizando o [Apache Airflow](https://airflow.apache.org/) e tamb√©m com base em algumas premissas compartilhadas pelo [Pedro Drummond](https://www.linkedin.com/in/pedro-drummond/) sobre o cen√°rio atual:
>
> - `650 municipios` atualmente com uma **m√©dia** entre a `5 - 8 usu√°rios`
> - A consolida√ß√£o √© feita diariamente, _logo_ **n√£o** se trata de uma `aplica√ß√£o real time`, o que _descarta_ integra√ß√µes sist√™micas mais robustas como Apache Kafka e comunica√ß√£o entre microservi√ßos.

- **Motiva√ß√£o**: Garantir maior confiabilidade, monitoramento e controle nas opera√ß√µes de ETL na infraestrutura da GCP.

**Benef√≠cios**:

- **Orquestra√ß√£o Avan√ßada na GCP**: Configurar DAGs no Apache Airflow para representar o fluxo do processo ETL, integrando ao [Cloud Composer](https://cloud.google.com/composer?hl=pt_br), permitindo monitorar as pipelines.

- üôå Integrar Cloud Monitoring e Cloud Logging para monitoramento detalhado, e/ou a partir das solu√ß√µes sugeridas de melhoria na tabela `An√°lise Cr√≠tica e Identifica√ß√£o de Riscos` - como integra√ß√µes entre [OpenTelemetry](https://cloud.google.com/stackdriver/docs/managed-prometheus/setup-otel?hl=pt-br), [Prometheus](https://prometheus.io/) e [Grafana](https://grafana.com/).

<details>
  <summary>
    üåü Apache Airflow - Destaques
  </summary>
&nbsp;

| Vantagem                            | Descri√ß√£o                                                                                                                                                      |
| ----------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **üîÑ Programa√ß√£o Declarativa**      | Permite a defini√ß√£o de fluxos de trabalho (DAGs) usando c√≥digo Python de forma declarativa, facilitando a leitura e manuten√ß√£o do c√≥digo.                      |
| **üé≠ Orquestra√ß√£o Flex√≠vel**        | Oferece uma plataforma flex√≠vel para a orquestra√ß√£o de tarefas, permitindo a execu√ß√£o de fluxos de trabalho complexos e cronogramas personalizados.            |
| **üîó Extensibilidade**              | Possui uma arquitetura modular e extens√≠vel que permite a adi√ß√£o de novos operadores, conex√µes e plugins para integrar com diversas tecnologias e servi√ßos.    |
| **üëÄ Monitoramento e Visualiza√ß√£o** | Fornece uma interface web amig√°vel para monitorar o status dos fluxos de trabalho, visualizar logs e m√©tricas, facilitando o diagn√≥stico de problemas.         |
| **‚ôªÔ∏è Reutiliza√ß√£o de C√≥digo**       | Permite a reutiliza√ß√£o de c√≥digo Python para definir tarefas, promovendo a modularidade e a f√°cil manuten√ß√£o de diferentes partes do fluxo de trabalho.        |
| **üóìÔ∏è Agendamento Din√¢mico**         | Oferece um agendador din√¢mico que permite a configura√ß√£o de cronogramas flex√≠veis e a execu√ß√£o de tarefas com base em eventos externos ou condi√ß√µes.           |
| **üöÄ Suporte a Execu√ß√£o Paralela**  | Facilita a execu√ß√£o paralela de tarefas, o que √© crucial para otimizar o desempenho em fluxos de trabalho complexos e distribu√≠dos.                            |
| **üîó Controle de Depend√™ncias**     | Gerencia automaticamente as depend√™ncias entre tarefas, garantindo que uma tarefa seja executada apenas quando suas depend√™ncias forem conclu√≠das com sucesso. |
| **‚öñÔ∏è Escalabilidade Horizontal**    | Pode ser escalado horizontalmente para lidar com grandes volumes de trabalho, distribuindo tarefas em v√°rios n√≥s de execu√ß√£o.                                  |
| **ü§ù Comunidade Ativa e Suporte**   | Beneficia-se de uma comunidade ativa de desenvolvedores e usu√°rios, com uma ampla gama de documenta√ß√£o, tutoriais e suporte online dispon√≠veis.                |

</details>

> A camada de implementa√ß√£o do processo de ETL com o Apache Airflow √© adicionada √† intera√ß√£o entre o Transmissor, a API Restful e a infraestrutura da GCP. Ap√≥s a extra√ß√£o e transmiss√£o dos dados, a API aciona uma DAG no Apache Airflow, que executa as tarefas ETL na GCP usando o Cloud Composer. Em seguida, as m√©tricas detalhadas s√£o registradas utilizando OpenTelemetry para dados de monitoramento e Prometheus para m√©tricas detalhadas. Essas m√©tricas s√£o visualizadas no Grafana, proporcionando uma vis√£o abrangente e detalhada do processo de ETL:

```mermaid

graph TD
  A[Transmissor] -->|Solicitar dados via API| B[API Restful]
  B -->|Autenticar e Extrair Dados| C[Banco Municipal]
  C -->|Dados Extra√≠dos| B
  B -->|Acionar DAG no Apache Airflow| D[Apache Airflow]
  D -->|Executar Tarefas ETL| E[GCP]
  E -->|Confirma√ß√£o de Execu√ß√£o| D
  D -->|Registrar Dados de Monitoramento| F[OpenTelemetry]
  D -->|Registrar M√©tricas Detalhadas| G[Prometheus]
  F -->|Visualiza√ß√£o de Dados de Monitoramento| H[Grafana]
  G -->|Visualiza√ß√£o de M√©tricas Detalhadas| H

```

```mermaid

sequenceDiagram
  participant Transmissor
  participant API_Restful
  participant Apache_Airflow
  participant BancoMunicipio
  participant GCP
  participant Cloud_Composer
  participant OpenTelemetry
  participant Prometheus
  participant Grafana

  Transmissor ->> API_Restful: Solicitar dados via API
  activate API_Restful

  API_Restful ->> BancoMunicipio: Autenticar e Extrair Dados
  note over BancoMunicipio: Processo seguro usando IAM

  BancoMunicipio -->> API_Restful: Dados Extra√≠dos

  API_Restful -->> Transmissor: Resposta com Dados

  API_Restful ->> Apache_Airflow: Acionar DAG no Apache Airflow
  activate Apache_Airflow

  Apache_Airflow ->> GCP: Executar Tarefas ETL
  note over GCP: Utilizando Cloud Composer para DAGs

  GCP -->> Apache_Airflow: Confirma√ß√£o de Execu√ß√£o

  Apache_Airflow ->> OpenTelemetry: Registrar Dados de Monitoramento
  Apache_Airflow ->> Prometheus: Registrar M√©tricas Detalhadas

  OpenTelemetry -->> Grafana: Visualiza√ß√£o de Dados de Monitoramento
  Prometheus -->> Grafana: Visualiza√ß√£o de M√©tricas Detalhadas

  deactivate API_Restful
  deactivate Apache_Airflow

```

---

#### 4.3 - üïµÔ∏è‚Äç‚ôÇÔ∏è Melhorias no Processo de Comunica√ß√£o - API intermedi√°ria:

Introdu√ß√£o de Camada de Servi√ßos Intermedi√°ria utilizando[Cloud Functions](https://cloud.google.com/functions?hl=pt_br) ou [Cloud Run](https://cloud.google.com/run?hl=pt_br) para criar uma API intermedi√°ria.

- Utilizar [Cloud Pub/Sub](https://cloud.google.com/pubsub?hl=pt_br) para gerenciar mensagens entre o `transmissor` e o `banco de dados do munic√≠pio`.

**Motiva√ß√£o:** Simplificar e fortalecer a comunica√ß√£o entre o `banco de dados do munic√≠pio` e a `base de dados na GCP`.

**Benef√≠cios:**

- **Padroniza√ß√£o na GCP**: Integrar servi√ßos de mensagens, como `Cloud Pub/Sub`, para padronizar a comunica√ß√£o entre o `transmissor` e o `banco de dados do munic√≠pio`.
- `T√∫nel Seguro`: Configurar uma VPN na GCP para estabelecer um t√∫nel seguro entre o transmissor e o banco de dados do munic√≠pio especialmente ao lidar com dados sens√≠veis.
- `Isolamento de Rede`: Utilizar as pol√≠ticas de seguran√ßa de rede (Firewall) da GCP para criar uma rede privada virtual, isolando a comunica√ß√£o.

---

#### 4.3.1 - üöÄ Proposta de implementa√ß√£o:

> - O Transmissor inicia o processo solicitando dados por meio de uma API para a API Intermedi√°ria.
> - A API Intermedi√°ria utiliza o Cloud Pub/Sub para publicar uma mensagem, gerenciando eficientemente a comunica√ß√£o entre o Transmissor e o Banco de Dados do Munic√≠pio.
> - A Cloud Functions √© acionada pela mensagem no Cloud Pub/Sub, realizando de forma segura a autentica√ß√£o e extra√ß√£o de dados do Banco do Munic√≠pio.
> - Ap√≥s a extra√ß√£o, a Cloud Functions responde ao Cloud Pub/Sub, que efetua a entrega eficiente da mensagem √† API Intermedi√°ria.
> - Esta, por sua vez, responde ao Transmissor com os dados extra√≠dos.
> - O restante do processo, incluindo a orquestra√ß√£o com o Apache Airflow e o monitoramento avan√ßado com OpenTelemetry, Prometheus e Grafana, prossegue conforme representado no diagrama de sequ√™ncia anterior.

```mermaid

sequenceDiagram
  participant Transmissor
  participant API_Intermediaria
  participant Cloud_PubSub
  participant Cloud_Functions
  participant BancoMunicipio
  participant API_Restful
  participant Apache_Airflow
  participant GCP
  participant Cloud_Composer
  participant OpenTelemetry
  participant Prometheus
  participant Grafana

  Transmissor ->> API_Intermediaria: Solicitar dados via API
  activate API_Intermediaria

  API_Intermediaria ->> Cloud_PubSub: Publicar mensagem
  activate Cloud_PubSub

  Cloud_PubSub -->> Cloud_PubSub: Gerenciar Mensagens

  Cloud_PubSub -->> Cloud_Functions: Acionar Fun√ß√£o
  activate Cloud_Functions

  Cloud_Functions ->> BancoMunicipio: Autenticar e Extrair Dados
  note over BancoMunicipio: Processo seguro usando IAM

  BancoMunicipio -->> Cloud_Functions: Dados Extra√≠dos

  Cloud_Functions -->> Cloud_PubSub: Resposta com Dados

  Cloud_PubSub -->> API_Intermediaria: Receber Mensagem

  API_Intermediaria -->> Transmissor: Resposta com Dados

  API_Intermediaria ->> Apache_Airflow: Acionar DAG no Apache Airflow
  activate Apache_Airflow

  Apache_Airflow ->> GCP: Executar Tarefas ETL
  note over GCP: Utilizando Cloud Composer para DAGs

  GCP -->> Apache_Airflow: Confirma√ß√£o de Execu√ß√£o

  Apache_Airflow ->> OpenTelemetry: Registrar Dados de Monitoramento
  Apache_Airflow ->> Prometheus: Registrar M√©tricas Detalhadas

  OpenTelemetry -->> Grafana: Visualiza√ß√£o de Dados de Monitoramento
  Prometheus -->> Grafana: Visualiza√ß√£o de M√©tricas Detalhadas

  deactivate API_Intermediaria
  deactivate Cloud_PubSub
  deactivate Cloud_Functions
  deactivate Apache_Airflow

```
